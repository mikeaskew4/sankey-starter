// This is a manifest file that'll be compiled into application.js, which will include all the files
// listed below.
//
// Any JavaScript/Coffee file within this directory, lib/assets/javascripts, or any plugin's
// vendor/assets/javascripts directory can be referenced here using a relative path.
//
// It's not advisable to add code directly here, but if you do, it'll appear at the bottom of the
// compiled file. JavaScript code in this file should be added after the last require_* statement.
//
// Read Sprockets README (https://github.com/rails/sprockets#sprockets-directives) for details
// about supported directives.
//
//= require rails-ujs
//= require activestorage
//= require turbolinks
//= require_tree .



var energy = {"nodes":[{"name":"0.0 Home","node":0,"color":"#142735"},{"name":"C01 Hero with Animation ","node":1,"color":"#9c8c64"},{"name":"C02 Introduction with CTA ","node":2,"color":"#9c8c64"},{"name":"C03 Promotional Grid ","node":3,"color":"#9c8c64"},{"name":"C04 Featured Posts ","node":4,"color":"#9c8c64"},{"name":"C05 CTA Blade ","node":5,"color":"#9c8c64"},{"name":"1.0 Section Landing 1 ","node":6,"color":"#142735"},{"name":"C06 Primary Hero","node":7,"color":"#9c8c64"},{"name":"C07 Call Out","node":8,"color":"#9c8c64"},{"name":"C08 Quick Links","node":9,"color":"#9c8c64"},{"name":"C05 CTA Blade","node":10,"color":"#9c8c64"},{"name":"1.1 Section Detail 1","node":11,"color":"#142735"},{"name":"C09 Secondary Hero 1","node":12,"color":"#9c8c64"},{"name":"C10 Icon Nav","node":13,"color":"#9c8c64"},{"name":"C11 Statement","node":14,"color":"#9c8c64"},{"name":"C12 Card Group 1","node":15,"color":"#9c8c64"},{"name":"C13 Spotlight","node":16,"color":"#9c8c64"},{"name":"C14 Testimonial Slider","node":17,"color":"#9c8c64"},{"name":"C15 Simple Job Listing","node":18,"color":"#9c8c64"},{"name":"C16 Card Group 2","node":19,"color":"#9c8c64"},{"name":"C17 Image Feed","node":20,"color":"#9c8c64"},{"name":"C18 CTA Blade with Image","node":21,"color":"#9c8c64"},{"name":"2.0 Section Landing 2","node":22,"color":"#142735"},{"name":"C19 Secondary Hero 2","node":23,"color":"#9c8c64"},{"name":"C20 Card Stack","node":24,"color":"#9c8c64"},{"name":"2.1 Section Detail 2","node":25,"color":"#142735"},{"name":"C21 Tertiary Hero 1","node":26,"color":"#9c8c64"},{"name":"C22 Tabs","node":27,"color":"#9c8c64"},{"name":"C23 Standard Promo","node":28,"color":"#9c8c64"},{"name":"3.0 Section Landing (who we are)","node":29,"color":"#142735"},{"name":"C24 Statement with Cards","node":30,"color":"#9c8c64"},{"name":"C25 Interactive Timeline","node":31,"color":"#9c8c64"},{"name":"C26 Profiles","node":32,"color":"#9c8c64"},{"name":"4.0 Posts Landing","node":33,"color":"#142735"},{"name":"C27 Featured Post Hero","node":34,"color":"#9c8c64"},{"name":"C28 Post Feed ","node":35,"color":"#9c8c64"},{"name":"4.1 Post Section","node":36,"color":"#142735"},{"name":"C29 Post Filter ","node":37,"color":"#9c8c64"},{"name":"4.1.1 Post Detail","node":38,"color":"#142735"},{"name":"C30 Post Hero","node":39,"color":"#9c8c64"},{"name":"C31 Rich Text Area","node":40,"color":"#9c8c64"},{"name":"C32 Gallery","node":41,"color":"#9c8c64"},{"name":"C33 Related Posts","node":42,"color":"#9c8c64"},{"name":"5.0 Join Us","node":43,"color":"#142735"},{"name":"C34 Tertiary Hero 2","node":44,"color":"#9c8c64"},{"name":"C35 Job Post Cards","node":45,"color":"#9c8c64"},{"name":"C36 Culture Spotlight with Cards","node":46,"color":"#9c8c64"},{"name":"C37 Culture Spotlight ","node":47,"color":"#9c8c64"},{"name":"C38 2-up Promo","node":48,"color":"#9c8c64"},{"name":"5.1 Job Listings","node":49,"color":"#142735"},{"name":"C39 Job Post Filter","node":50,"color":"#9c8c64"},{"name":"C40 Full Job Post Listing","node":51,"color":"#9c8c64"},{"name":"5.2 Location Detail","node":52,"color":"#142735"},{"name":"C41 Video Modal","node":53,"color":"#9c8c64"},{"name":"C42 Card Slider","node":54,"color":"#9c8c64"},{"name":"C43 Mini Job Post Listing","node":55,"color":"#9c8c64"},{"name":"5.1.1 Job Detail","node":56,"color":"#142735"},{"name":"C45 Job Hero","node":57,"color":"#9c8c64"},{"name":"C46 Job Details","node":58,"color":"#9c8c64"},{"name":"6.0 Contact","node":59,"color":"#142735"},{"name":"C47 Contact Form","node":60,"color":"#9c8c64"},{"name":"C48 Map Grid","node":61,"color":"#9c8c64"}],"links":[{"id":0,"value":1,"source":0,"target":1},{"id":1,"value":1,"source":0,"target":2},{"id":2,"value":1,"source":0,"target":3},{"id":3,"value":1,"source":0,"target":4},{"id":4,"value":1,"source":0,"target":5},{"id":5,"value":1,"source":6,"target":7},{"id":6,"value":1,"source":6,"target":8},{"id":7,"value":1,"source":6,"target":9},{"id":8,"value":1,"source":6,"target":10},{"id":9,"value":1,"source":11,"target":12},{"id":10,"value":1,"source":11,"target":13},{"id":11,"value":1,"source":11,"target":14},{"id":12,"value":1,"source":11,"target":15},{"id":13,"value":1,"source":11,"target":16},{"id":14,"value":1,"source":11,"target":17},{"id":15,"value":1,"source":11,"target":18},{"id":16,"value":1,"source":11,"target":19},{"id":17,"value":1,"source":11,"target":20},{"id":18,"value":1,"source":11,"target":21},{"id":19,"value":1,"source":22,"target":21},{"id":20,"value":1,"source":22,"target":23},{"id":21,"value":1,"source":22,"target":24},{"id":22,"value":1,"source":25,"target":4},{"id":23,"value":1,"source":25,"target":21},{"id":24,"value":1,"source":25,"target":26},{"id":25,"value":1,"source":25,"target":27},{"id":26,"value":1,"source":25,"target":28},{"id":27,"value":1,"source":29,"target":13},{"id":28,"value":1,"source":29,"target":26},{"id":29,"value":1,"source":29,"target":28},{"id":30,"value":1,"source":29,"target":30},{"id":31,"value":1,"source":29,"target":31},{"id":32,"value":1,"source":29,"target":32},{"id":33,"value":1,"source":33,"target":21},{"id":34,"value":1,"source":33,"target":34},{"id":35,"value":1,"source":33,"target":35},{"id":36,"value":1,"source":33,"target":35},{"id":37,"value":1,"source":36,"target":21},{"id":38,"value":1,"source":36,"target":26},{"id":39,"value":1,"source":36,"target":35},{"id":40,"value":1,"source":36,"target":37},{"id":41,"value":1,"source":38,"target":21},{"id":42,"value":1,"source":38,"target":39},{"id":43,"value":1,"source":38,"target":40},{"id":44,"value":1,"source":38,"target":41},{"id":45,"value":1,"source":38,"target":42},{"id":46,"value":1,"source":43,"target":13},{"id":47,"value":1,"source":43,"target":17},{"id":48,"value":1,"source":43,"target":21},{"id":49,"value":1,"source":43,"target":44},{"id":50,"value":1,"source":43,"target":45},{"id":51,"value":1,"source":43,"target":46},{"id":52,"value":1,"source":43,"target":47},{"id":53,"value":1,"source":43,"target":48},{"id":54,"value":1,"source":49,"target":23},{"id":55,"value":1,"source":49,"target":50},{"id":56,"value":1,"source":49,"target":50},{"id":57,"value":1,"source":49,"target":51},{"id":58,"value":1,"source":52,"target":23},{"id":59,"value":1,"source":52,"target":28},{"id":60,"value":1,"source":52,"target":53},{"id":61,"value":1,"source":52,"target":54},{"id":62,"value":1,"source":52,"target":55},{"id":63,"value":1,"source":56,"target":57},{"id":64,"value":1,"source":56,"target":58},{"id":65,"value":1,"source":59,"target":21},{"id":66,"value":1,"source":59,"target":60},{"id":67,"value":1,"source":59,"target":61}]};

var margin = {top: 1, right: 240, bottom: 6, left: 1},
    width = 1280 - margin.left - margin.right,
    height = 1500 - margin.top - margin.bottom;

var formatNumber = d3.format(",.0f"),
    format = function(d) { return formatNumber(d) + " TWh"; },
    color = d3.scale.category20();

var svg = d3.select("#chart").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var sankey = d3.sankey()
    .nodeWidth(15)
    .nodePadding(10)
    .size([width, height]);

var path = sankey.link();

sankey
    .nodes(energy.nodes)
    .links(energy.links)
    .layout(32);

var link = svg.append("g").selectAll(".link")
    .data(energy.links)
    .enter().append("path")
    .attr("class", "link")
    .attr("d", path)
    .attr("id", function(d,i){
        d.id = i;
        return "link-"+i;
    })
    .style("stroke-width", function(d) { return Math.max(1, d.dy); })
    .sort(function(a, b) { return b.dy - a.dy; });

link.append("title")
    .text(function(d) { return d.source.name + " â†’ " + d.target.name + "\n" + format(d.value); });

var node = svg.append("g").selectAll(".node")
    .data(energy.nodes)
    .enter().append("g")
    .attr("class", "node")
    .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })
    .on("click",highlight_node_links)
    .call(d3.behavior.drag()
        .origin(function(d) { return d; })
        // interfering with click .on("dragstart", function() { this.parentNode.appendChild(this); })
        .on("drag", dragmove));

node.append("rect")
    .attr("height", function(d) { return d.dy; })
    .attr("width", sankey.nodeWidth())
    .style("fill", function(d) { return d.color = color(d.name.replace(/ .*/, "")); })
    .style("stroke", function(d) { return d3.rgb(d.color).darker(2); })
    .append("title")
    .text(function(d) { return d.name + "\n" + format(d.value); });

node.append("text")
    .attr("x", 24)
    .attr("y", function(d) { return d.dy / 2; })
    .attr("dy", ".35em")
    .attr("text-anchor", "start")
    .attr("transform", null)
    .text(function(d) { return d.name; })
    .filter(function(d) { return d.x < width / 2; })
    .attr("x", 6 + sankey.nodeWidth())
    .attr("text-anchor", "start");

function dragmove(d) {
    d3.select(this).attr("transform", "translate(" + d.x + "," + (d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))) + ")");
    sankey.relayout();
    link.attr("d", path);
}

function highlight_node_links(node,i){
    d3.selectAll('path').style("stroke-opacity", 0.2);
    var remainingNodes=[],
        nextNodes=[];

    var stroke_opacity = 0;
    if( d3.select(this).attr("data-clicked") == "1" ){
        d3.select(this).attr("data-clicked","0");
        stroke_opacity = 0.2;
    }else{
        d3.select(this).attr("data-clicked","1");
        stroke_opacity = 0.5;
    }

    var traverse = [{
        linkType : "sourceLinks",
        nodeType : "target"
    },{
        linkType : "targetLinks",
        nodeType : "source"
    }];

    traverse.forEach(function(step){
        node[step.linkType].forEach(function(link) {
            remainingNodes.push(link[step.nodeType]);
            highlight_link(link.id, stroke_opacity);
        });

        while (remainingNodes.length) {
            nextNodes = [];
            remainingNodes.forEach(function(node) {
                node[step.linkType].forEach(function(link) {
                    nextNodes.push(link[step.nodeType]);
                    highlight_link(link.id, stroke_opacity);
                });
            });
            remainingNodes = nextNodes;
        }
    });
}

function highlight_link(id,opacity){

    d3.select("#link-"+id).style("stroke-opacity", opacity);
}

var node = svg.append("g").selectAll(".node")
    .data(energy.nodes)
    .enter().append("g")
    .attr("class", "node")
    .on("click",foo)
    .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })
    .call(d3.behavior.drag()
        .origin(function(d) { return d; })
        .on("dragstart", function() { this.parentNode.appendChild(this); })
        .on("drag", dragmove));

node.append("rect")
    .attr("height", function(d) { return d.dy; })
    .attr("width", sankey.nodeWidth())
    .style("fill", function(d) { return d.color = color(d.name.replace(/ .*/, "")); })
    .style("stroke", function(d) { return d3.rgb(d.color).darker(2); })
    .append("title")
    .text(function(d) { return d.name + "\n" + format(d.value); });

node.append("text")
    .attr("x", -6)
    .attr("y", function(d) { return d.dy / 2; })
    .attr("dy", ".35em")
    .attr("text-anchor", "end")
    .attr("transform", null)
    .text(function(d) { return d.name; })
    .filter(function(d) { return d.x < width / 2; })
    .attr("x", 6 + sankey.nodeWidth())
    .attr("text-anchor", "start");

function dragmove(d) {
    d3.select(this).attr("transform", "translate(" + d.x + "," + (d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))) + ")");
    sankey.relayout();
    link.attr("d", path);
}



